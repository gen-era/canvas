<form
      x-data="{
              uploading: false,
              init() {
              uploading = false;
              }
             }"
      hx-encoding="multipart/form-data"
      hx-trigger="submit"
    id="idat-upload-form"
>
    <div id="presigned-urls" style="display:none;">{{ presigned_urls }}</div>

    <label for="id_file_field">Select a directory with .idat files:</label>
    <input type="file" name="file" id="id_file_field"
           hx-preserve="true"
           multiple
           webkitdirectory
           mozdirectory
           onchange="triggerUpload()"
           >

    <div id="idat-upload-spinner" class="htmx-indicator">
        <svg width="16" height="16" viewBox="0 0 135 140" xmlns="http://www.w3.org/2000/svg" fill="#494949">
            <rect y="10" width="15" height="120" rx="6">
                <animate attributeName="height"
                    begin="0.5s" dur="1s"
                    values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear"
                    repeatCount="indefinite" />
                <animate attributeName="y"
                    begin="0.5s" dur="1s"
                    values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear"
                    repeatCount="indefinite" />
            </rect>
            <rect x="30" y="10" width="15" height="120" rx="6">
                <animate attributeName="height"
                    begin="0.25s" dur="1s"
                    values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear"
                    repeatCount="indefinite" />
                <animate attributeName="y"
                    begin="0.25s" dur="1s"
                    values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear"
                    repeatCount="indefinite" />
            </rect>
            <rect x="60" width="15" height="140" rx="6">
                <animate attributeName="height"
                    begin="0s" dur="1s"
                    values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear"
                    repeatCount="indefinite" />
                <animate attributeName="y"
                    begin="0s" dur="1s"
                    values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear"
                    repeatCount="indefinite" />
            </rect>
            <rect x="90" y="10" width="15" height="120" rx="6">
                <animate attributeName="height"
                    begin="0.25s" dur="1s"
                    values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear"
                    repeatCount="indefinite" />
                <animate attributeName="y"
                    begin="0.25s" dur="1s"
                    values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear"
                    repeatCount="indefinite" />
            </rect>
            <rect x="120" y="10" width="15" height="120" rx="6">
                <animate attributeName="height"
                    begin="0.5s" dur="1s"
                    values="120;110;100;90;80;70;60;50;40;140;120" calcMode="linear"
                    repeatCount="indefinite" />
                <animate attributeName="y"
                    begin="0.5s" dur="1s"
                    values="10;15;20;25;30;35;40;45;50;0;10" calcMode="linear"
                    repeatCount="indefinite" />
            </rect>
        </svg>
        Processing your files.
    </div>

    {% if presigned_urls|length > 0 %}
        <!-- TODO: dosya isimleri ile loopla, dictin keyleri
             Her biri için ayrı bir progress bar
             Bu da 16vh lik bir containerda overflowda dursun. -->
        <div
            x-show="uploading"
            id="progress-display" >
            <progress id='progress' value='0' max='100'></progress>
            <div id="percent-wrapper">
                <input id='percent' value="0" type="number" contenteditable="false" disabled/>
                <span>%</span>
            </div>
        </div>

        <button
            x-show="!uploading"
            @click="uploading = true; upload()"
            type="submit" id="upload-btn"
        >
            <span id="start-upload">Upload</span>
            <span id="loader">Uploading...</span>
        </button>
    {% endif %}

    <div id="upload-path">
        Uploaded {{ path }}
    </div>
</form>


<script type="text/javascript">
function triggerUpload() {
   const fileInput = document.querySelector("#id_file_field");
   const files = fileInput.files;

   // Collect only the file names to send in the request
   const fileNames = [];
   for (let i = 0; i < files.length; i++) {
       if (files[i].name.endsWith(".idat")){
        fileNames.push(files[i].name);
       }
   }

   // Manually trigger an HTMX request with file names as parameters
   htmx.ajax('POST', "{% url 'idat_upload' %}", {
       target: "#idat-upload-form",
       select: "#idat-upload-form",
       swap: "outerHTML",
       indicator: "#idat-upload-spinner",
       values: {
           file_names: JSON.stringify(fileNames)
       }
   });
}

function upload() {
      // Get selected files from the input element.
     presigned_urls_div = document.querySelector("#presigned-urls");
     var presigned_urls = JSON.parse(presigned_urls_div.textContent);

     console.log(presigned_urls);
     files = document.querySelector("#id_file_field").files;

     for (var i = 0; i < files.length; i++) {
         var file = files[i];
         console.log(file)
         uploadFile(file, presigned_urls[file.name]);
     }
     alert("upload finished")
     // TODO: tell the django upload finished
     // pass the files
 }

function uploadFile(file, url) {
     console.log(url)
     if (typeof url !== "undefined") {
        fetch(url, {
            method: 'PUT',
            body: file
        })
     }
}
</script>


<style>
    .htmx-indicator{
        display: none;
        opacity:0;
        transition: opacity 500ms ease-in;
    }
    .htmx-request .htmx-indicator{
        display: block;
        opacity:1;
    }
    .htmx-request.htmx-indicator{
        display: block;
        opacity:1;
    }
</style>
